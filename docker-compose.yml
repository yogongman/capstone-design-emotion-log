services:
  # 1. 데이터베이스
  db:
    image: postgres:15
    container_name: team-db
    restart: always
    env_file: .env
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      # [중요] DB 데이터 영구 저장소 (미니PC 절대 경로)
      - /home/hoon/team-project/pg-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  # 2. 백엔드 (Spring Boot)
  backend:
    build: ./backend
    container_name: team-backend
    restart: always
    depends_on:
      - db
    env_file: .env
    ports:
      - "8081:8080"
    environment:
      - SPRING_DATASOURCE_URL=${DB_URL}
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - GEMINI_API_KEY=${GEMINI_API_KEY}

  # 3. 프론트엔드 (React + Nginx)
  frontend:
    build: ./frontend
    container_name: team-frontend
    restart: always
    ports:
      - "3001:80"

  # 4. 로그 뷰어
  dozzle:
    image: amir20/dozzle
    container_name: team-log-viewer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "9999:8080"

  # 5. Cloudflare Tunnel
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: team-cloudflared
    restart: always
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}